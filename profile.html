<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªì s∆° c√° nh√¢n</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .profile-container {
            max-width: 800px;
            margin: 30px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .profile-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #667eea;
        }
        
        .avatar-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .avatar-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #667eea;
            margin-bottom: 15px;
        }
        
        .avatar-upload {
            display: none;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1>üìö T√†i li·ªáu CNTT</h1>
                </div>
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm t√†i li·ªáu..." />
                    <button id="searchBtn">üîç</button>
                </div>
                <nav class="nav">
                    <div id="authButtons" class="auth-buttons">
                        <button onclick="showLogin()">ƒêƒÉng nh·∫≠p</button>
                        <button onclick="showRegister()">ƒêƒÉng k√Ω</button>
                    </div>
                    <div id="userMenu" class="user-menu" style="display: none;">
                        <span id="userName"></span>
                        <div class="dropdown">
                            <button class="dropbtn">‚öôÔ∏è</button>
                            <div class="dropdown-content">
                                <a href="profile.html">H·ªì s∆°</a>
                                <a href="my-documents.html">T√†i li·ªáu c·ªßa t√¥i</a>
                                <a href="upload.html">T·∫£i l√™n</a>
                                <a href="#" id="adminLink" style="display: none;">Qu·∫£n tr·ªã</a>
                                <a href="index.html" onclick="logout()">ƒêƒÉng xu·∫•t</a>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="profile-container">
            <div class="profile-header">
                <h2>üë§ H·ªì s∆° c√° nh√¢n</h2>
            </div>
            
            <div class="avatar-section">
                <img id="avatarPreview" src="https://via.placeholder.com/150" alt="Avatar" class="avatar-preview">
                <br>
                <input type="file" id="avatarUpload" class="avatar-upload" accept="image/jpeg,image/png,image/jpg">
                <button class="btn-secondary" onclick="document.getElementById('avatarUpload').click()">
                    üì∑ Thay ƒë·ªïi ·∫£nh ƒë·∫°i di·ªán
                </button>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('info')">Th√¥ng tin c√° nh√¢n</button>
                <button class="tab" onclick="switchTab('password')">ƒê·ªïi m·∫≠t kh·∫©u</button>
            </div>
            
            <!-- Tab Th√¥ng tin -->
            <div id="infoTab" class="tab-content active">
                <form id="profileForm">
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="email" disabled>
                    </div>
                    
                    <div class="form-group">
                        <label>H·ªç t√™n: *</label>
                        <input type="text" id="full_name" name="full_name" required>
                    </div>
                    
                    <div class="form-group">
                        <label>M√£ s·ªë (SV/GV):</label>
                        <input type="text" id="student_code" name="student_code">
                    </div>
                    
                    <div class="form-group">
                        <label>Vai tr√≤:</label>
                        <input type="text" id="role" disabled>
                    </div>
                    
                    <div class="form-group">
                        <label>Khoa/L·ªõp:</label>
                        <input type="text" id="department" name="department">
                    </div>
                    
                    <div class="form-group">
                        <label>Ng√†y t·∫°o t√†i kho·∫£n:</label>
                        <input type="text" id="created_at" disabled>
                    </div>
                    
                    <button type="submit" class="btn-primary">üíæ C·∫≠p nh·∫≠t th√¥ng tin</button>
                </form>
            </div>
            
            <!-- Tab ƒê·ªïi m·∫≠t kh·∫©u -->
            <div id="passwordTab" class="tab-content">
                <form id="passwordForm">
                    <div class="form-group">
                        <label>M·∫≠t kh·∫©u c≈©: *</label>
                        <input type="password" name="old_password" required>
                    </div>
                    
                    <div class="form-group">
                        <label>M·∫≠t kh·∫©u m·ªõi: *</label>
                        <input type="password" name="new_password" required>
                        <small>T·ªëi thi·ªÉu 8 k√Ω t·ª±, c√≥ ch·ªØ hoa v√† s·ªë</small>
                    </div>
                    
                    <div class="form-group">
                        <label>X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi: *</label>
                        <input type="password" name="confirm_password" required>
                    </div>
                    
                    <button type="submit" class="btn-primary">üîí ƒê·ªïi m·∫≠t kh·∫©u</button>
                </form>
            </div>
        </div>
    </div>

 
    <script>
        const API_URL = 'api';
        
        document.addEventListener('DOMContentLoaded', function() {
            if (!requireAuth()) return;
            
            checkAuth();
            loadProfile();
            
            // Avatar upload handler
            document.getElementById('avatarUpload').addEventListener('change', uploadAvatar);
        });
        
        async function loadProfile() {
            try {
                const response = await fetch(`${API_URL}/user.php?action=profile`, {
                    headers: {
                        'Authorization': 'Bearer ' + getAuthToken()
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const user = result.data;
                    
                    document.getElementById('email').value = user.email;
                    document.getElementById('full_name').value = user.full_name;
                    document.getElementById('student_code').value = user.student_code || '';
                    document.getElementById('role').value = getRoleName(user.role);
                    document.getElementById('department').value = user.department || '';
                    document.getElementById('created_at').value = formatDate(user.created_at);
                    
                    if (user.avatar_url) {
                        document.getElementById('avatarPreview').src = user.avatar_url;
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin h·ªì s∆°', 'error');
            }
        }
        
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch(`${API_URL}/user.php?action=update-profile`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + getAuthToken()
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!', 'success');
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('C·∫≠p nh·∫≠t th·∫•t b·∫°i!', 'error');
            }
        });
        
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const newPassword = formData.get('new_password');
            const confirmPassword = formData.get('confirm_password');
            
            if (newPassword !== confirmPassword) {
                showAlert('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!', 'error');
                return;
            }
            
            if (newPassword.length < 8 || !/[A-Z]/.test(newPassword) || !/[0-9]/.test(newPassword)) {
                showAlert('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±, bao g·ªìm ch·ªØ hoa v√† s·ªë', 'error');
                return;
            }
            
            const data = {
                old_password: formData.get('old_password'),
                new_password: newPassword
            };
            
            try {
                const response = await fetch(`${API_URL}/auth.php?action=change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getAuthToken()
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!', 'success');
                    e.target.reset();
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('ƒê·ªïi m·∫≠t kh·∫©u th·∫•t b·∫°i!', 'error');
            }
        });
        
        async function uploadAvatar(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate
            const maxSize = 2 * 1024 * 1024; // 2MB
            const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg'];
            
            if (file.size > maxSize) {
                showAlert('·∫¢nh v∆∞·ª£t qu√° 2MB!', 'error');
                return;
            }
            
            if (!allowedTypes.includes(file.type)) {
                showAlert('Ch·ªâ ch·∫•p nh·∫≠n file JPG, JPEG, PNG!', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('avatar', file);
            
            try {
                const response = await fetch(`${API_URL}/user.php?action=upload-avatar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + getAuthToken()
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('avatarPreview').src = result.avatar_url;
                    showAlert('Upload avatar th√†nh c√¥ng!', 'success');
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Upload th·∫•t b·∫°i!', 'error');
            }
        }
        
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            if (tabName === 'info') {
                document.getElementById('infoTab').classList.add('active');
                document.querySelectorAll('.tab')[0].classList.add('active');
            } else {
                document.getElementById('passwordTab').classList.add('active');
                document.querySelectorAll('.tab')[1].classList.add('active');
            }
        }
        
        function getRoleName(role) {
            const roles = {
                'student': 'Sinh vi√™n',
                'teacher': 'Gi·∫£ng vi√™n',
                'staff': 'C√°n b·ªô',
                'admin': 'Qu·∫£n tr·ªã vi√™n'
            };
            return roles[role] || role;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN');
        }
        
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.profile-container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => alertDiv.remove(), 5000);
        }
    </script>
    <script src="js/auth.js"></script>
</body>
</html>