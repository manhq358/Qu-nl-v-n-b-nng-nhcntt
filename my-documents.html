<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√†i li·ªáu c·ªßa t√¥i</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .my-docs-container {
            max-width: 1200px;
            margin: 30px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #667eea;
        }
        
        .docs-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .docs-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        
        .docs-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .docs-table tr:hover {
            background: #f9f9f9;
        }
        
        .action-btns {
            display: flex;
            gap: 10px;
        }
        
        .btn-icon {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .btn-edit {
            background: #28a745;
            color: white;
        }
        
        .btn-edit:hover {
            background: #218838;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
        
        .btn-view {
            background: #007bff;
            color: white;
        }
        
        .btn-view:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1>üìö T√†i li·ªáu CNTT</h1>
                </div>
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm t√†i li·ªáu..." />
                    <button id="searchBtn">üîç</button>
                </div>
                <nav class="nav">
                    <div id="authButtons" class="auth-buttons">
                        <button onclick="showLogin()">ƒêƒÉng nh·∫≠p</button>
                        <button onclick="showRegister()">ƒêƒÉng k√Ω</button>
                    </div>
                    <div id="userMenu" class="user-menu" style="display: none;">
                        <span id="userName"></span>
                        <div class="dropdown">
                            <button class="dropbtn">‚öôÔ∏è</button>
                            <div class="dropdown-content">
                                 <a href="index.html" class="back-link">Trang ch·ªß</a>
                                <a href="profile.html">H·ªì s∆°</a>
                                <a href="my-documents.html">T√†i li·ªáu c·ªßa t√¥i</a>
                                <a href="upload.html">T·∫£i l√™n</a>
                                <a href="#" id="adminLink" style="display: none;">Qu·∫£n tr·ªã</a>
                                <a href="index.html" onclick="logout()">ƒêƒÉng xu·∫•t</a>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="my-docs-container">
            <div class="page-header">
                <h2>üìÇ T√†i li·ªáu c·ªßa t√¥i</h2>
                <button class="btn-primary" onclick="window.location.href='upload.html'">
                    ‚ûï T·∫£i l√™n m·ªõi
                </button>
            </div>
            
            <div id="documentsTable">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>ƒêang t·∫£i...</p>
                </div>
            </div>
            
            <div id="pagination" class="pagination"></div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>Ch·ªânh s·ª≠a t√†i li·ªáu</h2>
            <form id="editForm">
                <input type="hidden" id="editDocId">
                
                <div class="form-group">
                    <label>Ti√™u ƒë·ªÅ: *</label>
                    <input type="text" id="editTitle" maxlength="200" required>
                </div>
                
                <div class="form-group">
                    <label>M√¥ t·∫£: *</label>
                    <textarea id="editDescription" rows="5" maxlength="1000" required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Chuy√™n ng√†nh: *</label>
                    <select id="editCategory" required></select>
                </div>
                
                <div class="form-group">
                    <label>Lo·∫°i t√†i li·ªáu: *</label>
                    <select id="editType" required></select>
                </div>
                
                <div class="form-group">
                    <label>Thay ƒë·ªïi file (t√πy ch·ªçn):</label>
                    <input type="file" id="editFile" accept=".pdf,.docx,.zip">
                    <small>ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën thay ƒë·ªïi file</small>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">üíæ L∆∞u thay ƒë·ªïi</button>
                    <button type="button" class="btn-secondary" onclick="closeEditModal()">H·ªßy</button>
                </div>
            </form>
        </div>
    </div>

   
    <script>
        const API_URL = 'api';
        let currentPage = 1;
        
        document.addEventListener('DOMContentLoaded', function() {
            if (!requireAuth()) return;
            
            checkAuth();
            loadMyDocuments();
        });
        
        async function loadMyDocuments() {
            try {
                const response = await fetch(`${API_URL}/documents.php?action=my-documents&page=${currentPage}`, {
                    headers: {
                        'Authorization': 'Bearer ' + getAuthToken()
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayDocuments(result.data);
                    displayPagination(result.pagination);
                } else {
                    showError(result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Kh√¥ng th·ªÉ t·∫£i danh s√°ch t√†i li·ªáu');
            }
        }
        
        function displayDocuments(documents) {
            const container = document.getElementById('documentsTable');
            
            if (documents.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px;">B·∫°n ch∆∞a c√≥ t√†i li·ªáu n√†o. <a href="upload.html">T·∫£i l√™n t√†i li·ªáu ƒë·∫ßu ti√™n</a></p>';
                return;
            }
            
            const html = `
                <table class="docs-table">
                    <thead>
                        <tr>
                            <th>Ti√™u ƒë·ªÅ</th>
                            <th>Chuy√™n ng√†nh</th>
                            <th>Lo·∫°i</th>
                            <th>Ng√†y ƒëƒÉng</th>
                            <th>L∆∞·ª£t xem</th>
                            <th>L∆∞·ª£t t·∫£i</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${documents.map(doc => `
                            <tr>
                                <td><strong>${doc.title}</strong></td>
                                <td>${doc.category_name}</td>
                                <td>${doc.doc_type_name}</td>
                                <td>${formatDate(doc.created_at)}</td>
                                <td>üëÅÔ∏è ${doc.view_count}</td>
                                <td>‚¨áÔ∏è ${doc.download_count}</td>
                                <td>
                                    <div class="action-btns">
                                        <button class="btn-icon btn-view" onclick="viewDocument(${doc.id})" title="Xem">üëÅÔ∏è</button>
                                        <button class="btn-icon btn-edit" onclick="editDocument(${doc.id})" title="S·ª≠a">‚úèÔ∏è</button>
                                        <button class="btn-icon btn-delete" onclick="deleteDocument(${doc.id})" title="X√≥a">üóëÔ∏è</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        function displayPagination(pagination) {
            const container = document.getElementById('pagination');
            const { page, pages } = pagination;
            
            if (pages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = `<button onclick="changePage(${page - 1})" ${page === 1 ? 'disabled' : ''}>¬´ Tr∆∞·ªõc</button>`;
            
            for (let i = 1; i <= pages; i++) {
                html += `<button onclick="changePage(${i})" class="${i === page ? 'active' : ''}">${i}</button>`;
            }
            
            html += `<button onclick="changePage(${page + 1})" ${page === pages ? 'disabled' : ''}>Sau ¬ª</button>`;
            
            container.innerHTML = html;
        }
        
        function changePage(page) {
            currentPage = page;
            loadMyDocuments();
        }
        
        function viewDocument(id) {
            window.location.href = `document-detail.html?id=${id}`;
        }
        
        async function editDocument(id) {
            try {
                // Load document details
                const response = await fetch(`${API_URL}/documents.php?action=detail&id=${id}`);
                const result = await response.json();
                
                if (result.success) {
                    const doc = result.data;
                    
                    // Load categories and types
                    await loadCategoriesForEdit();
                    await loadTypesForEdit();
                    
                    // Fill form
                    document.getElementById('editDocId').value = doc.id;
                    document.getElementById('editTitle').value = doc.title;
                    document.getElementById('editDescription').value = doc.description;
                    document.getElementById('editCategory').value = doc.category_id;
                    document.getElementById('editType').value = doc.document_type_id;
                    
                    // Show modal
                    document.getElementById('editModal').style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin t√†i li·ªáu');
            }
        }
        
        async function loadCategoriesForEdit() {
            const response = await fetch(`${API_URL}/categories.php?action=list-categories`);
            const result = await response.json();
            
            if (result.success) {
                const select = document.getElementById('editCategory');
                select.innerHTML = result.data.map(cat => 
                    `<option value="${cat.id}">${cat.name}</option>`
                ).join('');
            }
        }
        
        async function loadTypesForEdit() {
            const response = await fetch(`${API_URL}/categories.php?action=list-types`);
            const result = await response.json();
            
            if (result.success) {
                const select = document.getElementById('editType');
                select.innerHTML = result.data.map(type => 
                    `<option value="${type.id}">${type.name}</option>`
                ).join('');
            }
        }
        
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('id', document.getElementById('editDocId').value);
            formData.append('title', document.getElementById('editTitle').value);
            formData.append('description', document.getElementById('editDescription').value);
            formData.append('category_id', document.getElementById('editCategory').value);
            formData.append('document_type_id', document.getElementById('editType').value);
            
            const fileInput = document.getElementById('editFile');
            if (fileInput.files.length > 0) {
                formData.append('file', fileInput.files[0]);
            }
            
            try {
                const response = await fetch(`${API_URL}/documents.php?action=update`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + getAuthToken()
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
                    closeEditModal();
                    loadMyDocuments();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('C·∫≠p nh·∫≠t th·∫•t b·∫°i!');
            }
        });
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editForm').reset();
        }
        
        async function deleteDocument(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i li·ªáu n√†y?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/documents.php?action=delete&id=${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + getAuthToken()
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('X√≥a th√†nh c√¥ng!');
                    loadMyDocuments();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('X√≥a th·∫•t b·∫°i!');
            }
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }
        
        function showError(message) {
            document.getElementById('documentsTable').innerHTML = `
                <div class="alert alert-error">${message}</div>
            `;
        }
    </script>

     <script src="js/auth.js"></script>
     <script src="js/app.js"></script>
</body>
</html>